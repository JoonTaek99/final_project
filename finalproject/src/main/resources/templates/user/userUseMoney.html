<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">

<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    <style type="text/css">
        body {
            background-color: #f2f2f2;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            position: relative;
        }
        
         #lineChart {
            background-color: white; 
        }

        #lineChartContainer {
          width: 800px;
          height: 400px;
          margin: 0 auto; /* 가운데 정렬을 위한 margin 속성 추가 */
      }


        #differenceContainer {
            margin-top: 20px;
            font-size: 30px;
            text-align: center;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script type="text/javascript">
        // 꺾은선 그래프를 그리는 함수
        function drawLineChart(labels, data) {
          var ctx = document.getElementById('lineChart').getContext('2d');
          var lineChart = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Total Use Money',
                      borderColor: 'rgb(32, 120, 195)',
                      data: data,
                      fill: false,
                  }]
              },
              options: {
                  scales: {
                      x: {
                          type: 'category',
                          position: 'bottom'
                      },
                      y: {
                          beginAtZero: true
                      }
                  },
                  plugins: {
                      datalabels: {
                          display: true,
                          color: 'black',
                          anchor: 'end',
                          align: 'end',
                          formatter: function(value, context) {
                              return value.y;
                          }
                      }
                  },
              }
          });
      }

        function drawChartWithData() {
            $.ajax({
                url: "/banking/dayUseMoney",
                method: "get",
                dataType: "json",
                async: false,
                success: function (data) {
                    var labels = [];
                    var chartData = [];

                    for (var i = 0; i < data.length; i++) {
                        labels.push(data[i].REGDATE);
                        chartData.push({ x: data[i].REGDATE, y: data[i].TOTALUSEMONEY });
                    }

                    drawLineChart(labels, chartData);

                    var todayUseMoney = data[data.length - 1].TOTALUSEMONEY;
                    var yesterdayUseMoney = data[data.length - 2].TOTALUSEMONEY;
                    var difference = todayUseMoney - yesterdayUseMoney;

                   var differenceContainer = document.getElementById('differenceContainer');
               if (difference < 0) {
                   differenceContainer.innerHTML = '어제보다 <u>' + Math.abs(difference) + '원</u> 만큼 덜 썼어요';
               } else if (difference > 0) {
                   differenceContainer.innerHTML = '어제보다 <u>' + difference + '원</u> 만큼 더 썼어요';
               } else {
                   differenceContainer.innerText = '어제와 동일한 금액을 사용했어요';
               }
                },

                error: function () {
                    console.log("데이터 가져오기 실패");
                }
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            drawChartWithData();
        });
    </script>
</head>
<body>
    <div layout:fragment="content">
        <h1>계좌 확인</h1>
        <div id="lineChartContainer">
            <canvas id="lineChart"></canvas>
        </div>
        <div id="differenceContainer"></div>
    </div>
</body>
</html>