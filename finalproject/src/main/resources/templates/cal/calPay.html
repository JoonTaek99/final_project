<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{layouts/signuplayout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script type="text/javascript">

$("#usage").val(20000);

onload = function myInfo() {
    // Function to calculate and update the remaining balance
    function updateRemainingBalance() {
        var currentBalance = parseFloat($("#currentBalance").val());
        var usageAmount = parseFloat($("#usage").val());

        // Check if both values are valid numbers
        if (!isNaN(currentBalance) && !isNaN(usageAmount)) {
            var remainingBalance = Math.floor(currentBalance - usageAmount);
            $("#remainingBalance").val(remainingBalance);
        }
    }

    $.ajax({
        url: "/banking/getMyAccount",
        method: "get",
        dataType: "json",
        success: function (data) {
            var accountDropdown = $("#accountDropdown");

            accountDropdown.empty();

            $.each(data, function(index, account) {
                var option = $("<option>");

                option.val(account.money); // Set fintech_use_num as the value
                option.text(account.fintech_use_num + ' [' + account.bank_name + ']');

                accountDropdown.append(option);
            });

            // Add change event listener to the accountDropdown
            accountDropdown.change(function() {
                // Get the selected value
                var selectedValue = $(this).val();

                // Update the #currentBalance input with the selected value
                $("#currentBalance").val(selectedValue);

                // Update the #finusenum input with the fintech_use_num
                $("#finusenum").val(accountDropdown.find(":selected").text().split('[')[0].trim());

                // Update the remaining balance
                updateRemainingBalance();
            });

            // Set the value of the input with id 'usage' to 20000
            $("#usage").val(20000);

            // Show the moneyDiv immediately
            $("#moneyDiv").show();
        }
    });
}


// Function to handle changes in the usage input
$("#usage").on("input", function() {
    // Update the remaining balance whenever the usage input changes
    updateRemainingBalance();
});






function insertaccount() {
    var selectedValue = $("#accountDropdown").val();
    $.ajax({
        url: "/banking/insertaccount",
        method: "get",
        data: { "fintech_use_num": selectedValue },
        dataType: "json",
        success: function (data) {
            alert("등록이 완료되었습니다.");

            updatePaymentSelect(selectedValue);

            document.getElementById("usage").value = "20000";

            document.getElementById("currentBalance").value = data.balance_amt;

            var remainingBalance = data.balance_amt - 20000;
            document.getElementById("remainingBalance").value = remainingBalance;

            // Update the #finusenum input with the fintech_use_num
            $("#finusenum").val($("#accountDropdown option:selected").text().split('[')[0].trim());

            $("#moneyDiv").show();
        },
        error: function () {
            alert("등록에 실패했습니다.");
        }
    });
}


function payInfo() {
    var selectedfinusenum = $("#finusenum").val();
    var remainingBalance = $("#remainingBalance").val();

    $.ajax({
        url: "/cal/pay",
        method: "get",
        data: {"fintech_use_num": selectedfinusenum, "remaining_balance": remainingBalance},
        dataType: "json",
        // success: function (data) {
        //     alert("결제가 완료되었습니다.");
        // },
        // error: function () {
        //     alert("결제에 실패했습니다.");
        // }
    });
}
    
function updatePaymentSelect(selectedValue) {
    $("#paymentDropdown").append(
        '<option value="' + selectedValue + '">' + $("#accountDropdown option:selected").text() + '</option>'
    );
}
</script>
<style type="text/css">
    .select-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    select {
        margin-right: 10px;
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
    }

    button {
        padding: 8px; 
        border: 1px solid #007bff; 
        border-radius: 4px; 
        background-color: #007bff; 
        color: #fff; 
        cursor: pointer;
    }

    #moneyDiv {
        display: none; 
    }

    #usage,
    #remainingBalance,
    #currentBalance {
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        margin-right: 10px; 
    }
</style>
</head>
<body>
<div layout:fragment="content">
    <h1>간편결제</h1>
    
    <div class="select-container">
        <select id="accountDropdown"></select>
    </div>

    <div id="moneyDiv" class="select-container">
        <p style="display: inline-block;">현재잔액</p>
        <input id="currentBalance" readonly><br/>
        <p style="display: inline-block;">사용금액</p>
        <input id="usage" readonly><br/>
        <p style="display: inline-block;">남은잔액</p>
        <input id="remainingBalance" readonly>
        <p style="display: inline-block;">fintech_use_num</p>
        <input id="finusenum" readonly>
    </div>

    <div class="select-container">
        <button onclick="payInfo()">결제</button>
    </div>
</div>
</body>
</html>
