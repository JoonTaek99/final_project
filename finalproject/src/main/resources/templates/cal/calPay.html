<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
     xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
     layout:decorate="~{layouts/signuplayout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script type="text/javascript">
    onload = function myInfo() {
        $.ajax({
            url: "/banking/myinfo",
            method: "get",
            dataType: "json",
            success: function (data) {
                console.log(data.res_list);
                var res_list = data.res_list; // 나의 계좌목록 저장
                // 출력할 내용
                // 계좌이름
                // 핀테크이용번호 [은행이름]
                $("#list").append('<select id="accountDropdown">');
                for (var i = 0; i < res_list.length; i++) {
                    $("#accountDropdown").append(
                        '<option value="' + res_list[i].fintech_use_num + '">'
                        + res_list[i].account_alias + ' - '
                        + res_list[i].account_num_masked + ' ['
                        + res_list[i].bank_name + ']</option>'
                    );
                }
                $("#list").append('</select>');
            }
        });
    }

    function insertaccount() {
        var selectedValue = $("#accountDropdown").val();
        $.ajax({
            url: "/banking/insertaccount",
            method: "get",
            data: { "fintech_use_num": selectedValue },
            dataType: "json",
            success: function (data) {
                alert("등록이 완료되었습니다.");

                updatePaymentSelect(selectedValue);

                document.getElementById("usage").value = "20000";

                document.getElementById("currentBalance").value = data.balance_amt;

                var remainingBalance = data.balance_amt - 20000;
                document.getElementById("remainingBalance").value = remainingBalance;

                $("#moneyDiv").show();
            },
            error: function () {
                alert("등록에 실패했습니다.");
            }
        });
    }

    function payInfo() {
        var selectedValue = $("#paymentDropdown").val();
        var remainingBalance = $("#remainingBalance").val();

        $.ajax({
            url: "/cal/pay",
            method: "get",
            data: {"fintech_use_num": selectedValue,"remaining_balance": remainingBalance},
            dataType: "json",
//             success: function (data) {
//                 alert("결제가 완료되었습니다.");
                
//             },
//             error: function () {
//                 alert("결제에 실패했습니다.");
//             }
        });


    }
    
    function updatePaymentSelect(selectedValue) {
        $("#paymentDropdown").append(
            '<option value="' + selectedValue + '">' + $("#accountDropdown option:selected").text() + '</option>'
        );
    }
</script>
<style type="text/css">
    .select-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    select {
        margin-right: 10px;
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
    }

    button {
        padding: 8px; 
        border: 1px solid #007bff; 
        border-radius: 4px; 
        background-color: #007bff; 
        color: #fff; 
        cursor: pointer;
    }

    #moneyDiv {
        display: none; 
    }

    #usage,
    #remainingBalance,
    #currentBalance {
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
        margin-right: 10px; 
    }
</style>
</head>
<body>
<div layout:fragment="content">
    <h1>간편결제</h1>
    
    <div class="select-container">
        <select id="accountDropdown"></select>
        <button onclick="insertaccount()">등록</button>
    </div>

    <div id="moneyDiv" class="select-container">
        <p style="display: inline-block;">현재잔액</p>
        <input id="currentBalance" readonly><br/>
        <p style="display: inline-block;">사용금액</p>
        <input id="usage" readonly><br/>
        <p style="display: inline-block;">남은잔액</p>
        <input id="remainingBalance" readonly>
    </div>

    <div class="select-container">
        <select id="paymentDropdown"></select>
        <button onclick="payInfo()">결제</button>
    </div>
</div>
</body>
</html>
